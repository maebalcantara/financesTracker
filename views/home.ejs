<%- include("partials/header") -%>
<!-- test for pop up -->
<div id="liveAlertPlaceholder"></div>

<label for="sampleCapital"><strong>Current Captital:</strong></label>
<span><%=finalCapital%></span>

<div class="container-fluid">
  <div class="row">
      <!-- Portfolio Table -->
    <div class="col-md-8">
      <div class="div-portfolio">
        <h3>Portfolio Table</h3>
        <table class="table-portfolio">
          <tr>
            <th>Action</th>
            <th>Stock Code</th>
            <th>Market Price</th>
            <th>Purchase Price</th>
            <th>Number of Shares</th>
            <th>Total Price</th>
            <th>Gain/Loss (Percent)</th>
            <th>Gain/Loss (Monetary)</th>
          </tr>
      
          <% stockEntryLoop.forEach((value, index) => { %>
          <% let styleColor = value.glMonetary >= 0 ? 'green' : 'red' %>
          <tr>
            <td>
              <form action="/home" method="post">
                <!-- counter? -->
                <!-- Buy -->
                <button class="button-buy" type="submit" value="<%=value.stockCode%>" name="sellStockCode">BUY </button> |
                <!-- Sell -->
                <button class="button-sell" type="submit" value="<%=value.stockCode%>" name="sellStockCode">SELL</button>
              </form>
            </td>
            <td style="text-transform: uppercase;"> <%= value.stockCode %> </td>
            <td> P <%= value.marketPrice %> </td>
            <td> P <%= value.purchasePrice %> </td>
            <td> <%= value.totalShares %> </td>
            <td> P <%= value.totalPrice %> </td>
            <td style="color:<%=styleColor%>"> <%= value.glPercentage %> % </td>
            <td style="color:<%=styleColor%>"> P <%= value.glMonetary %> </td>
          </tr>
          <% }) %>
          <tr>
            <td colspan="5"><strong>Total:</strong></td>
            <td><strong>P <%=finalPrice%></strong></td>
            <td><strong><%=finalGLPercentage%> %</strong> </td>
            <td><strong>P <%=finalGLMonetary%></strong></td>
          </tr>
          <tr>
            <td colspan="5"><strong>Total + Cash</strong></td>
            <td colspan="4"><strong>P <%=finalCapital%></strong></td>
          </tr>
        </table>
      </div>
        <!-- History Table -->
      <div class="div-history">
        <h3>History Table</h3>
        <table class="table-history">
          <tr>
            <th>Date Posted</th>
            <th>Stock Code</th>
            <th>Action</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
          <% historyEntryLoop.forEach((value) => { %>
          <tr>
            <td><%=value.datePosted%></td>
            <td style="text-transform: uppercase;"><%=value.stockCode%></td>
            <td><%=value.action%></td>
            <td><%=value.quantity%></td>
            <td><%=value.price%></td>
            <td><%=value.total%></td>
          </tr>
          <% }) %>
        </table>
      </div>
    </div>
    <div class="col-md-4 div-buy">
      <h3>Buy and Sell</h3>
      <form action="/home" method="post">
        <div class="container-fluid">
          <!-- Buy Option -->
          <div style="display: inline;">
            <input type="radio" id="transactionBuy" name="transactionChoice" value="BUY" onclick="onClick()" required>
            <label for="transaction-buy">Buy</label>
          </div>
          <!-- Sell Option -->
          <div style="display: inline;">
            <input type="radio" id="transactionSell" name="transactionChoice" value="SELL" onclick="onClick()" required>
            <label for="transaction-buy">Sell</label>
          </div>

          <!-- Stock Code -->
          <div class="row">
            <div class="col-4">
              <label for="stockCode"> <strong>Stock Code:</strong></label>
            </div>
            <div class="col-8">
              <input style="text-transform: uppercase;" type="text" id="stockCode" name="stockCode" value="<%=stockCode%>" autocomplete="off" required /> 
            </div>
          </div>

          <!-- Market Price -->
          <div class="row">
            <div class="col-4">
              <label for="marketPrice"> <strong>Market Price:</strong></label>
            </div>
            <div class="col-8">
              <input type="text" name="marketPrice" id="marketPrice" onChange="onChange()" oninput="validateNumber(this);" autocomplete="off" required />
            </div>
          </div>
           <!-- Purchase Price -->

          <div class="row">
            <div class="col-4">
              <label for="purchasePrice"> <strong>Purchase Price:</strong></label>
            </div>
            <div class="col-8">
              <input type="text" name="purchasePrice" id="purchasePrice" onChange="onChange()" oninput="validateNumber(this);" autocomplete="off" required />
            </div>
          </div>

          <!-- Number of Shares -->
          <div class="row">
            <div class="col-4">
              <label for="totalShares"> <strong>Total Shares:</strong></label>
            </div>
            <div class="col-8">
              <input type="text" name="totalShares" id="totalShares" onChange="onChange()" oninput="validateNumber(this);" autocomplete="off" required />
            </div>
          </div>
      
          <!-- Total Price -->
          <div class="row">
            <div class="col-4">
              <strong>Total Price: </strong>
            </div>
            <div class="col-8">
              <!-- <input type="text" name="totalPrice" id="totalPrice" disabled/> -->
              <span name="totalPrice" id="totalPrice">0</span>
            </div>
          </div>
      
          <div class="row">
            <table id="tableTransactionCurrentShares" class="table tableTransactionCurrentShares" style="display: none;">
              <thead>
                <tr>
                  <th colspan=" 2" id="transactionTransactionChoice" scope="row">
              </th>
              </tr>
              </thead>
              <tbody>
                <tr>
                  <th id="transactionCurrentSharesTitle1" scope="row"></th>
                  <td id="transactionCurrentSharesCurrentStocks"></td>
                </tr>
                <tr>
                  <th id="transactionCurrentSharesTitle2" scope="row"></th>
                  <td id="transactionCurrentSharesAdjustedStocks"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- <button id="buyAndSellButton" type="submit" >Enter Info</button> -->
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transactionModal">
            Submit Transaction
          </button>
          
          <!-- Start of Modal -->
          <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="transactionModalLabel">CONFIRM ORDER DETAILS:</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">   
                  <strong>Stock Code: </strong><span id="stockCodeModal" style="text-transform: uppercase;"></span> <br/>
                  <strong>Market Price: </strong><span id="marketPriceModal"></span>  <br/>
                  <strong>Purchase Price: </strong><span id="purchasePriceModal"></span>  <br/>
                  <strong>Total Shares: </strong><span id="totalSharesModal"></span>  <br/>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Proceed</button>
                </div>
              </div>
            </div>
          </div>
          <!-- End of modal -->
        </div>        
      </form>
    </div>
  </div>
</div>

<!-- <form action="/test" method="post">
  <input type="text" name="popuptext" placeholder="test"/>
   <button type="submit" id="testButtonClose" >Test pop up</button>
</form>
   -->
<a href="/login"><button class="btn btn-primary">Log out</button></a>
<script>
   // This block is for pop up alerts
    var alertPlaceholder = document.getElementById('liveAlertPlaceholder')
    var alertTrigger = document.getElementById('testButtonClose')
    var messageTest = ""
    var typeTest =""
    function alert(message, type) {
      var wrapper = document.createElement('div')
      wrapper.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '<button type="button" class="btn-close"   data-bs-dismiss="alert" aria-label="Close"></button></div>'
    
      alertPlaceholder.append(wrapper)
    }
    
    if (alertTrigger){ 
        alertTrigger.addEventListener('click', function () {
        alert(document.getElementById("testButtonClose").innerHTML == 'Close' && 'Closed', document.getElementById("testButtonClose").innerHTML == 'Close' && 'danger')
        })
        
  }
    //End pop up alerts

  // Get Calculation
  function onChange() {
    var stockCode = document.getElementById("stockCode").value;
    var price = document.getElementById("purchasePrice").value;
    var stocks = parseFloat(document.getElementById("totalShares").value).toFixed(2);
    var marketPrice = document.getElementById("marketPrice").value;

    var total = price * stocks;
    document.getElementById("totalPrice").innerHTML = total;
    //Modal Output
    document.getElementById("stockCodeModal").innerHTML = stockCode;
    document.getElementById("marketPriceModal").innerHTML = marketPrice;
    document.getElementById("purchasePriceModal").innerHTML = price;
    document.getElementById("totalSharesModal").innerHTML = stocks;
  }

  function onlyNumberKey(evt) {
    // Only ASCII character in that range allowed
    var ASCIICode = (evt.which) ? evt.which : evt.keyCode
    if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 57))
      return false;
      return true;
  }
  
  var validNumber = new RegExp(/^\d*\.?\d*$/);
    var lastValid = document.getElementById("test1").value;
    function validateNumber(elem) {
      if (validNumber.test(elem.value)) {
        lastValid = elem.value;
      } else {
        elem.value = lastValid;
      }
    }
    
  function onClick(){
    document.getElementById("tableTransactionCurrentShares").style.display="";
    
    //Clear values
    document.getElementById("transactionCurrentSharesAdjustedStocks").innerHTML = 0
    document.getElementById("totalShares").value = ""
    document.getElementById("purchasePrice").value = ""
    document.getElementById("marketPrice").value = ""
    document.getElementById("totalPrice").innerHTML = 0


    var transactionChoice = document.getElementsByName('transactionChoice');
    for (i = 0; i < transactionChoice.length; i++) {
      if (transactionChoice[i].checked)
        document.getElementById("transactionTransactionChoice").innerHTML = transactionChoice[i].value + " ORDER";
        document.getElementById("transactionCurrentSharesTitle1").innerHTML = "Current Shares";
        document.getElementById("transactionCurrentSharesTitle2").innerHTML = "Adjusted Shares";
        document.getElementById("transactionCurrentSharesCurrentStocks").innerHTML = "<%=totalShares%>";
    }
  }
</script>

<%- include("partials/footer") -%>
